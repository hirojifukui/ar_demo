<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Code + Multiple Image Overlays</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  
  <!-- jsQR library for decoding real QR codes -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
      background: #000;
    }
    /* The video and overlayCanvas overlap */
    #video, #overlayCanvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    /* We'll keep the scanCanvas hidden */
    #scanCanvas {
      display: none;
    }
    /* Info panel in top-left corner */
    #info {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 999;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      padding: 0.5em;
      max-width: 90%;
    }
    /* Center the "Enable Audio" button on the screen */
    #enableAudioBtn {
      display: none;
      position: absolute;
      top: 50%;            /* position at vertical center */
      left: 50%;           /* position at horizontal center */
      transform: translate(-50%, -50%); /* adjust for button width/height */
      padding: 1em;
      font-size: 1em;
      background: #333;
      color: #fff;
      border: none;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="info">Initializing camera...</div>

  <!-- A button that appears AFTER detecting the first QR code, ONLY if audio isn't enabled yet -->
  <button id="enableAudioBtn">Enable Audio</button>

  <!-- Live camera feed -->
  <video id="video" autoplay playsinline></video>

  <!-- Visible canvas for live feed + overlays -->
  <canvas id="overlayCanvas"></canvas>

  <!-- Hidden canvas for scanning (jsQR) only -->
  <canvas id="scanCanvas"></canvas>

  <script>
    /************************************************************************
     * 1) Lookup maps: codeToImage, codeToAudio
     ************************************************************************/
    const codeToImage = {
      "01": "https://www.myrisu.com/us/img/method03.png",
      "02": "https://www.myrisu.com/us/img/method01.png",
      "03": "https://www.myrisu.com/us/img/method02.png",
      "04": "images/04.png",
      "05": "images/05.png",
      // ...
      "20": "images/20.png"
    };

    const codeToAudio = {
      "01": "https://www.9mtx.com/ar_demo/voice1.mp3",
      "02": "https://www.9mtx.com/ar_demo/voice2.mp3",
      "03": "https://www.9mtx.com/ar_demo/voice3.mp3",
      "04": "https://www.9mtx.com/ar_demo/voice4.mp3",
      "05": "https://www.9mtx.com/ar_demo/voice5.mp3",
      // ...
      "20": "https://www.9mtx.com/ar_demo/voice20.mp3"
    };

    /************************************************************************
     * 2) DOM References
     ************************************************************************/
    const video = document.getElementById('video');
    const overlayCanvas = document.getElementById('overlayCanvas');
    const overlayCtx = overlayCanvas.getContext('2d');
    const scanCanvas = document.getElementById('scanCanvas');
    const scanCtx = scanCanvas.getContext('2d');
    const info = document.getElementById('info');
    const enableAudioBtn = document.getElementById('enableAudioBtn');

    let detectionInfo = null;          // Data of the latest QR code
    let scanningPaused = false;        // Whether scanning is paused
    let audioEnabled = false;          // True after user enables audio once

    // We'll keep one Image() object that we update each time a new code is found.
    const overlayImg = new Image();

    /************************************************************************
     * 3) Request the camera
     ************************************************************************/
    const constraints = {
      video: {
        facingMode: "environment",
        width: { ideal: 640 },
        height: { ideal: 480 }
      }
    };

    navigator.mediaDevices.getUserMedia(constraints)
      .then(stream => {
        video.srcObject = stream;
        video.play();
        requestAnimationFrame(tick);
      })
      .catch(err => {
        console.error("Camera access denied:", err);
        info.textContent = "Error accessing camera: " + err;
      });

    /************************************************************************
     * 4) Audio Element
     ************************************************************************/
    const qrAudio = new Audio();
    qrAudio.addEventListener("ended", () => {
      // When audio finishes, resume scanning and clear detection
      scanningPaused = false;
      detectionInfo = null;
    });

    /************************************************************************
     * 5) "Enable Audio" button logic
     ************************************************************************/
    enableAudioBtn.addEventListener("click", () => {
      if (!qrAudio.src) {
        // If for some reason no code was assigned, pick a fallback
        qrAudio.src = "https://www.9mtx.com/ar_demo/voice1.mp3";
      }
      qrAudio.currentTime = 0;
      qrAudio.play()
        .then(() => {
          // As soon as audio starts playing, hide the button
          enableAudioBtn.style.display = "none";
          audioEnabled = true; // We have user permission now!
        })
        .catch(err => {
          console.warn("Audio playback blocked or failed:", err);
        });
    });

    /************************************************************************
     * 6) Main Loop
     ************************************************************************/
    function tick() {
      // 6a) Draw live video to overlayCanvas
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        overlayCanvas.width = video.videoWidth;
        overlayCanvas.height = video.videoHeight;
        overlayCtx.drawImage(video, 0, 0, overlayCanvas.width, overlayCanvas.height);
      }

      // 6b) If scanning is active, attempt to decode QR in scanCanvas
      if (!scanningPaused && video.readyState === video.HAVE_ENOUGH_DATA) {
        scanCanvas.width = video.videoWidth;
        scanCanvas.height = video.videoHeight;

        scanCtx.drawImage(video, 0, 0, scanCanvas.width, scanCanvas.height);
        const imageData = scanCtx.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
        const code = jsQR(imageData.data, scanCanvas.width, scanCanvas.height, {
          inversionAttempts: "dontInvert"
        });

        if (code) {
          // Found a QR code -> pause scanning
          scanningPaused = true;
          detectionInfo = {
            corners: code.location,
            data: code.data
          };

          // Load the corresponding 2D image (if any)
          overlayImg.src = codeToImage[code.data] || "";

          // If there's an audio associated, set it
          if (codeToAudio[code.data]) {
            qrAudio.src = codeToAudio[code.data];
          } else {
            qrAudio.src = "";
          }

          // Show the button if audio not yet enabled
          if (!audioEnabled) {
            enableAudioBtn.style.display = "block";
          } else {
            // Audio is already enabled => play automatically
            qrAudio.currentTime = 0;
            qrAudio.play().catch(err => {
              console.warn("Audio playback blocked or failed:", err);
            });
          }
        }
      }

      // 6c) Display info & overlay
      if (scanningPaused && detectionInfo) {
        info.textContent = "QR Data: " + detectionInfo.data;
        // We no longer call drawCorners(detectionInfo.corners);   <=== RED LINE REMOVED
        drawImageOverCode(detectionInfo.corners);
      } else {
        if (!detectionInfo) {
          info.textContent = "Scanning for QR Code...";
        }
      }

      requestAnimationFrame(tick);
    }

    /************************************************************************
     * 7) Drawing Function (no red line)
     ************************************************************************/
    function drawImageOverCode(location) {
      const minX = Math.min(location.topLeftCorner.x, location.bottomLeftCorner.x);
      const maxX = Math.max(location.topRightCorner.x, location.bottomRightCorner.x);
      const minY = Math.min(location.topLeftCorner.y, location.topRightCorner.y);
      const maxY = Math.max(location.bottomLeftCorner.y, location.bottomRightCorner.y);

      const w = maxX - minX;
      const h = maxY - minY;

      if (overlayImg.src) {
        overlayCtx.drawImage(overlayImg, minX, minY, w, h);
      }
    }
  </script>
</body>
</html>
