<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Code + Multiple Image Overlays</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  
  <!-- jsQR library for decoding real QR codes -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
      background: #000;
    }
    /* The video and overlayCanvas overlap */
    #video, #overlayCanvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    /* We'll keep the scanCanvas hidden */
    #scanCanvas {
      display: none;
    }
    /* Info panel in top-left corner */
    #info {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 999;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      padding: 0.5em;
      max-width: 90%;
    }
    /* Button that appears after detecting a QR code (only if audio isn't enabled yet) */
    #enableAudioBtn {
      display: none; /* hidden by default */
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
      padding: 1em;
      font-size: 1em;
      background: #333;
      color: #fff;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="info">Initializing camera...</div>

  <!-- A button that appears AFTER detecting a QR code, ONLY if audio isn't yet enabled -->
  <button id="enableAudioBtn">Enable Audio</button>

  <!-- Live camera feed -->
  <video id="video" autoplay playsinline></video>

  <!-- Visible canvas for live feed + overlays -->
  <canvas id="overlayCanvas"></canvas>

  <!-- Hidden canvas for scanning (jsQR) only -->
  <canvas id="scanCanvas"></canvas>

  <script>
    /************************************************************************
     * 1) Lookup maps: codeToImage, codeToAudio
     *    - Replace these URLs with your own as needed.
     ************************************************************************/
    const codeToImage = {
      "01": "https://www.myrisu.com/us/img/method03.png",
      "02": "https://www.myrisu.com/us/img/method01.png",
      "03": "https://www.myrisu.com/us/img/method02.png",
      "04": "images/04.png",
      "05": "images/05.png",
      // ...
      "20": "images/20.png"
    };

    const codeToAudio = {
      "01": "https://www.9mtx.com/ar_demo/voice1.mp3",  // or "audio/01.mp3" etc
      "02": "https://www.9mtx.com/ar_demo/voice2.mp3",
      "03": "https://www.9mtx.com/ar_demo/voice3.mp3",
      "04": "https://www.9mtx.com/ar_demo/voice4.mp3",
      "05": "https://www.9mtx.com/ar_demo/voice5.mp3",
      // ...
      "20": "https://www.9mtx.com/ar_demo/voice20.mp3"
    };

    /************************************************************************
     * 2) DOM References
     ************************************************************************/
    const video = document.getElementById('video');
    const overlayCanvas = document.getElementById('overlayCanvas');
    const overlayCtx = overlayCanvas.getContext('2d');
    const scanCanvas = document.getElementById('scanCanvas');
    const scanCtx = scanCanvas.getContext('2d');
    const info = document.getElementById('info');
    const enableAudioBtn = document.getElementById('enableAudioBtn');

    // We'll store info about the latest QR code detection here
    let detectionInfo = null;
    // Manage scanning + audio states
    let scanningPaused = false;
    let audioEnabled = false;  // We'll set to true after user allows audio once

    // We'll keep one Image() object that we update each time a new code is found.
    const overlayImg = new Image();

    /************************************************************************
     * 3) Request the camera
     ************************************************************************/
    const constraints = {
      video: {
        facingMode: "environment",
        width: { ideal: 640 },
        height: { ideal: 480 }
      }
    };

    navigator.mediaDevices.getUserMedia(constraints)
      .then(stream => {
        video.srcObject = stream;
        video.play();
        requestAnimationFrame(tick);
      })
      .catch(err => {
        console.error("Camera access denied:", err);
        info.textContent = "Error accessing camera: " + err;
      });

    /************************************************************************
     * 4) Create an <audio> element on-the-fly
     *    We'll swap out its .src for each detected code, if available.
     ************************************************************************/
    const qrAudio = new Audio();

    // Once the audio ends, hide the button and resume scanning.
    qrAudio.addEventListener("ended", () => {
      enableAudioBtn.style.display = "none";
      scanningPaused = false;
      detectionInfo = null;  // Clear old detection so we can detect a fresh code
    });

    /************************************************************************
     * 5) "Enable Audio" button logic
     ************************************************************************/
    enableAudioBtn.addEventListener("click", () => {
      // If we haven't assigned a particular .src yet (unlikely, but just in case),
      // fallback to something non-empty so iOS will allow playback.
      if (!qrAudio.src) {
        qrAudio.src = "https://www.9mtx.com/ar_demo/voice1.mp3";
      }
      qrAudio.currentTime = 0;
      qrAudio.play()
        .then(() => {
          audioEnabled = true; // We have user permission now!
        })
        .catch(err => {
          console.warn("Audio playback blocked or failed:", err);
        });
    });

    /************************************************************************
     * 6) Main Loop
     ************************************************************************/
    function tick() {
      // 6a) Draw live video to overlayCanvas so user can see the camera feed
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        overlayCanvas.width = video.videoWidth;
        overlayCanvas.height = video.videoHeight;
        overlayCtx.drawImage(video, 0, 0, overlayCanvas.width, overlayCanvas.height);
      }

      // 6b) If scanning is active, attempt to decode QR in scanCanvas
      if (!scanningPaused && video.readyState === video.HAVE_ENOUGH_DATA) {
        scanCanvas.width = video.videoWidth;
        scanCanvas.height = video.videoHeight;

        // Draw the current video frame into our hidden scanCanvas
        scanCtx.drawImage(video, 0, 0, scanCanvas.width, scanCanvas.height);
        const imageData = scanCtx.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
        const code = jsQR(imageData.data, scanCanvas.width, scanCanvas.height, {
          inversionAttempts: "dontInvert",
        });

        if (code) {
          // Found a QR code -> pause scanning
          scanningPaused = true;
          detectionInfo = {
            corners: code.location,
            data: code.data
          };

          // Load the corresponding 2D image (if available)
          if (codeToImage[code.data]) {
            overlayImg.src = codeToImage[code.data];
          } else {
            overlayImg.src = "";
          }

          // If there's an audio associated with this code, set it
          if (codeToAudio[code.data]) {
            qrAudio.src = codeToAudio[code.data];
          } else {
            // If no audio is associated, you can set an empty string or fallback
            qrAudio.src = "";
          }

          // If user has not enabled audio, show the button now
          if (!audioEnabled) {
            enableAudioBtn.style.display = "block";
          } else {
            // Audio is already enabled -> play it automatically
            qrAudio.currentTime = 0;
            qrAudio.play().catch(err => {
              console.warn("Audio playback blocked or failed:", err);
            });
          }
        }
      }

      // 6c) If scanning is paused (code found) and we have detection info, show overlay
      if (scanningPaused && detectionInfo) {
        info.textContent = "QR Data: " + detectionInfo.data;
        //drawCorners(detectionInfo.corners);
        drawImageOverCode(detectionInfo.corners);
      } else {
        // Otherwise, scanning for a new code
        if (!detectionInfo) {
          info.textContent = "Scanning for QR Code...";
        }
      }

      requestAnimationFrame(tick);
    }

    /************************************************************************
     * 7) Drawing Functions (Optional)
     ************************************************************************/
    // Draw polygon around the code
    function drawCorners(location) {
      const { topLeftCorner, topRightCorner, bottomRightCorner, bottomLeftCorner } = location;
      overlayCtx.beginPath();
      overlayCtx.moveTo(topLeftCorner.x, topLeftCorner.y);
      overlayCtx.lineTo(topRightCorner.x, topRightCorner.y);
      overlayCtx.lineTo(bottomRightCorner.x, bottomRightCorner.y);
      overlayCtx.lineTo(bottomLeftCorner.x, bottomLeftCorner.y);
      overlayCtx.closePath();
      overlayCtx.lineWidth = 3;
      overlayCtx.strokeStyle = "red";
      overlayCtx.stroke();
    }

    // Draw the currently loaded overlay image at the bounding box
    function drawImageOverCode(location) {
      const minX = Math.min(location.topLeftCorner.x, location.bottomLeftCorner.x);
      const maxX = Math.max(location.topRightCorner.x, location.bottomRightCorner.x);
      const minY = Math.min(location.topLeftCorner.y, location.topRightCorner.y);
      const maxY = Math.max(location.bottomLeftCorner.y, location.bottomRightCorner.y);

      const w = maxX - minX;
      const h = maxY - minY;

      // If overlayImg.src is not empty, draw it
      if (overlayImg.src) {
        overlayCtx.drawImage(overlayImg, minX, minY, w, h);
      }
    }
  </script>
</body>
</html>
